{"cells":[{"cell_type":"markdown","source":["#**Импорт библиотек**"],"metadata":{"id":"d6SNCbHnizNu"},"id":"d6SNCbHnizNu"},{"cell_type":"code","source":["sudo apt install libpq-dev python3-dev"],"metadata":{"id":"K0z2NdpLhE-E","executionInfo":{"status":"error","timestamp":1701112316864,"user_tz":-180,"elapsed":255,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}},"outputId":"cfdfce01-b1e8-4ba7-936d-a2c278ad1b2b","colab":{"base_uri":"https://localhost:8080/","height":140}},"id":"K0z2NdpLhE-E","execution_count":1,"outputs":[{"output_type":"error","ename":"SyntaxError","evalue":"ignored","traceback":["\u001b[0;36m  File \u001b[0;32m\"<ipython-input-1-e9dd95fa3ded>\"\u001b[0;36m, line \u001b[0;32m1\u001b[0m\n\u001b[0;31m    sudo apt install libpq-dev python3-dev\u001b[0m\n\u001b[0m         ^\u001b[0m\n\u001b[0;31mSyntaxError\u001b[0m\u001b[0;31m:\u001b[0m invalid syntax\n"]}]},{"cell_type":"code","execution_count":2,"id":"d7b42de7","metadata":{"id":"d7b42de7","executionInfo":{"status":"ok","timestamp":1701112320977,"user_tz":-180,"elapsed":3865,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["import numpy as np\n","import pandas as pd\n","import matplotlib.pyplot as plt\n","from tensorflow import keras\n","from keras.layers import Dense, Conv2D, MaxPooling2D, Flatten, Dropout\n","import sklearn\n","import os\n","from sklearn import preprocessing, model_selection\n","from PIL import Image\n","from tensorflow.keras.preprocessing.image import ImageDataGenerator\n","import tensorflow as tf"]},{"cell_type":"markdown","source":["#**Считывание изображений первого персонажа**"],"metadata":{"id":"H6WfyTPpiyla"},"id":"H6WfyTPpiyla"},{"cell_type":"code","execution_count":5,"id":"b710abde","metadata":{"id":"b710abde","executionInfo":{"status":"ok","timestamp":1701112471620,"user_tz":-180,"elapsed":91109,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["X1 = np.array([\n","    np.array(\n","        Image.open('/content/drive/MyDrive/Colab Notebooks/Kim/{}.PNG'.format(i))\n","        .resize((128, 128))\n","        .convert('RGB')\n","    ).reshape((128, 128, 3))\n","    for i in range(1, 251)\n","])\n","#X1 = X1/255."]},{"cell_type":"code","source":["from google.colab import drive\n","drive.mount('/content/drive')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"7J0lJmWZMRfO","executionInfo":{"status":"ok","timestamp":1701112375695,"user_tz":-180,"elapsed":26433,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}},"outputId":"b924e457-663d-438a-bb30-9b05b0ff8b50"},"id":"7J0lJmWZMRfO","execution_count":4,"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}]},{"cell_type":"markdown","source":["#**Считывание изображение второго персонажа**"],"metadata":{"id":"x-JN0tIwjFru"},"id":"x-JN0tIwjFru"},{"cell_type":"code","execution_count":null,"id":"7ab2fc3e","metadata":{"id":"7ab2fc3e"},"outputs":[],"source":["X2 = np.array([\n","    np.array(\n","        Image.open('/content/drive/MyDrive/Saul/{}.PNG'.format(i))\n","        .resize((128, 128))\n","        .convert('RGB') # добавляем конвертацию в RGB\n","    ).reshape((128, 128, 3)) # изменяем форму массива\n","    for i in range(1, 251)\n","])\n","#X2 = X2/255."]},{"cell_type":"markdown","source":["#**Объединение в общий X(train)**"],"metadata":{"id":"XBbn3O6cjNF3"},"id":"XBbn3O6cjNF3"},{"cell_type":"code","execution_count":null,"id":"c3835ad7","metadata":{"id":"c3835ad7"},"outputs":[],"source":["X = np.concatenate([X1, X2], axis=0)"]},{"cell_type":"markdown","source":["#**Аугментация данных (не запускать, портит точность)**"],"metadata":{"id":"OBNOhCouimIn"},"id":"OBNOhCouimIn"},{"cell_type":"code","execution_count":null,"id":"7365f00b","metadata":{"id":"7365f00b","executionInfo":{"status":"aborted","timestamp":1701112321371,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["# Создание генератора изображений для аугментации\n","datagen = ImageDataGenerator(featurewise_center=False,\n","    samplewise_center=False,\n","    featurewise_std_normalization=False,\n","    samplewise_std_normalization=False,\n","    zca_whitening=False,\n","    rotation_range=0.5,           # Диапазон поворота изображения в градусах\n","    width_shift_range=0.5,       # Диапазон горизонтального смещения изображения\n","    height_shift_range=0.5,      # Диапазон вертикального смещения изображения\n","    shear_range=0.2,             # Диапазон сдвига (скоса) изображения\n","    zoom_range=0.5,              # Диапазон масштабирования изображения\n","    horizontal_flip=False,\n","    vertical_flip=False,       # Отражение изображения по горизонтали\n","   fill_mode='nearest'          # Метод заполнения пикселей за пределами границ изображения\n",")\n","\n","# Преобразование и аугментация исходных изображений\n","Xgen = []\n","for i in range(X.shape[0]):\n","    x = X[i]\n","    x = x.reshape((1,) + x.shape)\n","    for batch in datagen.flow(x, batch_size=1):\n","        Xgen.append(batch.reshape(batch.shape[1:]))\n","        break\n","\n","# Объединение исходных и аугментированных изображений\n","X = np.concatenate((X, np.array(Xgen)))"]},{"cell_type":"markdown","source":["#**Создание Y для картинок, где 0 = Saul, а Kim = 1**"],"metadata":{"id":"Py2JG4V6jVA0"},"id":"Py2JG4V6jVA0"},{"cell_type":"code","execution_count":null,"id":"d20601e1","metadata":{"id":"d20601e1","executionInfo":{"status":"aborted","timestamp":1701112321371,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["Y = np.array([\n","    1 if i<250 else 0 for i in range(500)\n","])"]},{"cell_type":"markdown","source":["##**Увеличения Y пропорционально X**"],"metadata":{"id":"H2JwgzeKjo1z"},"id":"H2JwgzeKjo1z"},{"cell_type":"code","execution_count":null,"id":"c96e47eb","metadata":{"id":"c96e47eb","executionInfo":{"status":"aborted","timestamp":1701112321371,"user_tz":-180,"elapsed":13,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["Y = np.concatenate((Y, Y))"]},{"cell_type":"markdown","source":["#**Создаём x/y_test и x/y_train добавляя случайные значения(шумы)**"],"metadata":{"id":"-NQu7hGwj8g2"},"id":"-NQu7hGwj8g2"},{"cell_type":"code","execution_count":null,"id":"bf51a547","metadata":{"id":"bf51a547","executionInfo":{"status":"aborted","timestamp":1701112321372,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["import random\n","\n","random.seed(42)\n","rand_state = random.randint(1, 100)\n","\n","x_train, x_test, y_train, y_test = model_selection.train_test_split(X, Y, train_size=0.95, random_state=rand_state)"]},{"cell_type":"markdown","source":["#**Структура свёрточной нейронной сети**"],"metadata":{"id":"gTPKEejaiiTc"},"id":"gTPKEejaiiTc"},{"cell_type":"code","execution_count":null,"id":"994567c7","metadata":{"id":"994567c7","executionInfo":{"status":"aborted","timestamp":1701112321372,"user_tz":-180,"elapsed":13,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["model = keras.Sequential([\n","    Conv2D(32, (3, 3), padding=\"same\", activation=\"relu\", input_shape=(128, 128, 3)),\n","    MaxPooling2D((2, 2), strides=3),\n","    Conv2D(64, (3, 3), padding=\"same\", activation=\"relu\"),\n","    MaxPooling2D((2, 2), strides=2),\n","    Conv2D(128, (3, 3), padding=\"same\", activation=\"relu\"),\n","    MaxPooling2D((2, 2), strides=2),\n","    Conv2D(256, (3, 3), padding=\"same\", activation=\"relu\"),\n","    MaxPooling2D((2, 2), strides=2),\n","    Conv2D(512, (3, 3), padding=\"same\", activation=\"relu\"),\n","    MaxPooling2D((2, 2), strides=2),\n","    Conv2D(1024, (3, 3), padding=\"same\", activation=\"relu\"),\n","    MaxPooling2D((2, 2), strides=2),\n","    Flatten(),\n","    Dense(1, activation=\"sigmoid\")\n","])"]},{"cell_type":"markdown","source":["#**Установление метрики, оптимизатора и фунции потерь**"],"metadata":{"id":"9fKGs_X8kT_E"},"id":"9fKGs_X8kT_E"},{"cell_type":"code","execution_count":null,"id":"002679b3","metadata":{"id":"002679b3","executionInfo":{"status":"aborted","timestamp":1701112321373,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["model.compile(optimizer=keras.optimizers.Adam(), loss=\"binary_crossentropy\", metrics=[\"accuracy\"])"]},{"cell_type":"markdown","source":["#**Обучение СНН**"],"metadata":{"id":"tcQ2pbMukeZb"},"id":"tcQ2pbMukeZb"},{"cell_type":"code","execution_count":null,"id":"2e0417d9","metadata":{"scrolled":true,"id":"2e0417d9","executionInfo":{"status":"aborted","timestamp":1701112321373,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["model.fit(x_train, y_train, batch_size=128, epochs=50)"]},{"cell_type":"markdown","source":["#**Оценка точности на тесте**"],"metadata":{"id":"FaKFtpOAknXA"},"id":"FaKFtpOAknXA"},{"cell_type":"code","execution_count":null,"id":"b28353e4","metadata":{"id":"b28353e4","executionInfo":{"status":"aborted","timestamp":1701112321374,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"outputs":[],"source":["score, acc = model.evaluate(x_test, y_test)"]},{"cell_type":"markdown","source":["#**Создание Confusion matrix**"],"metadata":{"id":"6WZ56e_ZktJK"},"id":"6WZ56e_ZktJK"},{"cell_type":"code","source":["import seaborn as sns\n","from sklearn.metrics import confusion_matrix\n","\n","pred = model.predict(x_test)\n","\n","cm = confusion_matrix(y_test, np.round(pred))\n","\n","sns.heatmap(cm, annot=True, cmap=\"Greens\")\n","plt.title(\"Confusion Matrix\")\n","plt.xlabel(\"Predicted Label\")\n","plt.ylabel(\"True Label\")\n","plt.show()"],"metadata":{"id":"sGvYjDIiWY7D","executionInfo":{"status":"aborted","timestamp":1701112321374,"user_tz":-180,"elapsed":14,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"id":"sGvYjDIiWY7D","execution_count":null,"outputs":[]},{"cell_type":"code","source":["lst= np.array(Image.open('/content/BCS_206_UC_0914_0519-RT.jpg').resize((128, 128)).convert('RGB'))\n","score, acc = model.evaluate(lst, 1)"],"metadata":{"id":"_KMtVjOwh4Kr","executionInfo":{"status":"aborted","timestamp":1701112321375,"user_tz":-180,"elapsed":15,"user":{"displayName":"Кирилл Батов","userId":"04624207600922976786"}}},"id":"_KMtVjOwh4Kr","execution_count":null,"outputs":[]}],"metadata":{"kernelspec":{"display_name":"Python 3 (ipykernel)","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.9.13"},"colab":{"provenance":[{"file_id":"1uUy0JhIS7bvq7qaTZ82_y3k4gVgrLkN_","timestamp":1682378611009}]},"accelerator":"GPU","gpuClass":"standard"},"nbformat":4,"nbformat_minor":5}